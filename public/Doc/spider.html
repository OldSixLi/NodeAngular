<!-- 马少博  创建于 2017年4月20日09:20:57 -->
<!DOCTYPE html>
<html lang='en'>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel='shortcut icon' href='https://raw.githubusercontent.com/OldSixLi/ListPage/master/myapp/public/images/my.ico' />
    <title> 标题</title>
    <link href='http://cdn.bootcss.com/bootstrap/3.3.4/css/bootstrap.min.css' rel='stylesheet'>
    <link href="../Script/Masonry/style/chromagallery.min.css" rel='stylesheet'>

    <style>
      #container {
        /*display: flex;*/
      }
      
      #container .box {
        width: 16.66%;
        float: left;
      }
      
      .box>img {
        max-width: 100%;
        margin: 5px 0;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="input-group">
        <input type="text" class="form-control input-lg" id="questionUrl" placeholder="请输入搜索地址">
        <span class="input-group-btn">
        <button class="btn btn-primary btn-lg" type="button" onclick="beginSpider()">　开始抓取　</button>
      </span>
      </div>
      <hr>
    </div>

    <div id="container" class="once container" style="padding-top:20px;">
      <div class="box" id="imgblock2"> </div>
      <div class="box" id="imgblock3"> </div>
      <div class="box" id="imgblock4"> </div>
      <div class="box" id="imgblock5"> </div>
      <div class="box" id="imgblock6"> </div>
      <div class="box" id="imgblock1"> </div>

    </div>
    <div id="zancun">
    </div>
    <!-- 脚本 -->
    <script src='http://cdn.bootcss.com/jquery/1.9.1/jquery.min.js'></script>
    <script src='../Script/Masonry/scripts/chromagallery.pkgd.min.js'></script>
    <script src='http://cdn.bootcss.com/bootstrap/3.3.4/js/bootstrap.min.js'></script>
    <script src="//cdnjscn.b0.upaiyun.com/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
    <script src="../Script/webscoket/socket.io.js"></script>
    <script src="../Script/webscoket/desktopnotify.js"></script>
    <!--<script src="../Script/ScoketByMa.js"></script>-->
    <script src="../Script/webscoket/common.js"></script>
    <script>
      var chat_server = 'http://' + location.hostname + ':3000';
      console.log('server: ' + chat_server);
      var socket = io.connect(chat_server);
      var imgIndex = 1;

      //webscoket相关代码
      socket.on('mashaobo', function(data) {
        socket.emit('mashaobotest', '前台传输数据成功'); //前台传输数据
        socket.emit('FileWatch', '前台传输数据成功'); //前台传输数据

      });

      // socket.on('FileChange', function(data) {
      //   // socket.emit('mashaobotest', '前台传输数据成功'); //前台传输数据
      //   //刷新当前页面.
      //   window.location.reload();
      // });
      // FileChange
      var settime = 0,
        str = "",
        ad = 1;
      socket.on('ImgData', function(data) { // src="/images/1.jpg"
        if (data) {
          settime++;
          // $("#zancun").append('<b data-url="' + data + '" data-index="' + imgIndex + '"></b>');
          str = "<img src=" + data + "  class='img-responsive img-thumbnail'>";
          //   imgIndex++;
        }

        var yushu = settime % 6 + 1;
        // $("#imgblock" + yushu).append()

        var obj = {

          },
          arr = [];

        // obj['imgblock1-' + $("#imgblock1").height()] = '#imgblock1';
        // obj['imgblock2-' + $("#imgblock2").height()] = '#imgblock2';
        // obj['imgblock3-' + $("#imgblock3").height()] = '#imgblock3';
        // obj['imgblock4-' + $("#imgblock4").height()] = '#imgblock4';
        // obj['imgblock5-' + $("#imgblock5").height()] = '#imgblock5';
        // obj['imgblock6-' + $("#imgblock6").height()] = '#imgblock6';
        obj[$("#imgblock1").height()] = '#imgblock1';
        obj[$("#imgblock2").height()] = '#imgblock2';
        obj[$("#imgblock3").height()] = '#imgblock3';
        obj[$("#imgblock4").height()] = '#imgblock4';
        obj[$("#imgblock5").height()] = '#imgblock5';
        obj[$("#imgblock6").height()] = '#imgblock6';


        arr.push($("#imgblock1").height());
        arr.push($("#imgblock2").height());
        arr.push($("#imgblock3").height());
        arr.push($("#imgblock4").height());
        arr.push($("#imgblock5").height());
        arr.push($("#imgblock6").height());
        console.log("↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓");
        console.log(arr.join(','));
        console.log("↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑");
        var minnum = Math.min.apply(Math, arr);

        var selectors = obj[minnum];
        console.log("↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓");
        console.log("最小的是：" + selectors);
        console.log("↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑");
        $(selectors).append(str)
          // if (settime % 3 == 0) {
          //   $("#container").prepend(str); //向容器内一次性添加12个图片  
          //   $("#container").find(".once").slice(6, 12).removeClass('once');
          //   waterFlow(); //瀑布流布局
          //   str = "";
          //   settime = 0;
          // }

        // if ($("#container").find(".box").length >= 12 && ad == 1) {
        //   $("#container").removeClass('once');
        //   $("#container").find(".box").slice(6, 12).remove();
        //   // waterFlow(); //瀑布流布局
        //   ad = 2;

        // } else {
        //   return;
        // }
      });

      function beginSpider() {
        var word = $("#questionUrl").val();
        if (!word) {
          alert("请输入内容");
        } else {
          if (word.indexOf('www.zhihu.com')) {
            word = word.substr(word.lastIndexOf('/') + 1);
          }
          socket.emit('SpiderBegin', word);
        }

      }

      $(function() {



        var imgWidth = $(".box").innerWidth(); //获得每个div的宽度，包括内边距  
        var screenWidth = $(window).width(); //获得浏览器可视区域的宽度  
        var num = Math.floor(screenWidth / imgWidth); //计算一行可以放几个div  
        $("#container").css({
          "width": num * imgWidth + "px",
          "margin": "0 auto"
        }); //根据每行放的div的总长来给容器一个宽度，然后居中显示  
        console.log($(document).height())
        console.log($(window).height())
        window.onload = function() {
          // waterFlow(); //图片加载完毕执行  

          window.onscroll = function() {
            //滚动条滚动执行  
            // if (checkScrollDirector()) {
            //   var urlList = [];
            //   $("#zancun").find('b').slice(0, 12).each(function(index) {
            //     var url = $(this).attr("data-url");
            //     urlList.push(url);
            //   }).remove();
            //   if (urlList.length == 0) {
            //     return false;
            //   }
            //   for (var i = 0; i < urlList.length; i++) {
            //     var html = "<div class='box'><div class='boximg'><img src=" + urlList[i] + "></div></div>";
            //     $("#container").append(html); //向容器内一次性添加12个图片  
            //     console.log(1);
            //   }
            // waterFlow(); //瀑布流布局   
            // }
          }
        }
      });

      function getMinIndex(arr, min) { //取得数组中最小高度的div的索引  
        for (var i in arr) {
          if (arr[i] == min) {
            return i;
          }
        }
      }
      // .scrollTop(100);aaaaaaaaaaaaaa
      function checkScrollDirector() { //判断滚动条是否滑到底部  
        var flag = 0;
        if ($(document).scrollTop() + $(window).height() >= $(document).height()) {
          flag = 1;

        }
        return flag;
      }

      function waterFlow() {
        var imgWidth = $(".box").innerWidth(); //获得每个div的宽度，包括内边距  
        var screenWidth = $(window).width(); //获得浏览器可视区域的宽度  
        var num = Math.floor(screenWidth / imgWidth); //计算一行可以放几个div  
        var arr = []; //定义一个数组  
        for (var i = 0; i < $(".box").length; i++) {
          if (i < num) { //一行显示num个div,将第一行的每个div高度写入数组  
            arr[i] = $(".box").eq(i).innerHeight();
          } else {
            var minImgHeight = Math.min.apply(null, arr); //取得数组中最小高度的div  
            var index = getMinIndex(arr, minImgHeight); //取得数组中最小高度的div的索引  
            $(".box").eq(i).css({
              "position": "absolute",
              "top": minImgHeight + "px",
              "left": $(".box").eq(index).offset().left + "px"
            }); //瀑布流布局  
            arr[index] += $(".box").eq(i).innerHeight(); //将布局好的该div的高度和该div上面的div高度相加，重新放入数组  
          }
        }
      }
    </script>
  </body>

</html>