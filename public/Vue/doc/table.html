<!-- 马少博  创建于 2017年5月8日14:08:44 -->
<!DOCTYPE html>
<html lang='en'>

<head>
  <meta charset='utf-8'>
  <meta http-equiv='X-UA-Compatible' content='IE=edge'>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <link rel='shortcut icon' href='https://raw.githubusercontent.com/OldSixLi/ListPage/master/public/images/my.ico' />
  <title> Vue表格</title>
  <link href='http://cdn.bootcss.com/bootstrap/3.3.4/css/bootstrap.min.css' rel='stylesheet'>
  <style>
    td>img {
      width: 30px;
      height: 30px;
      margin-right: 10px;
    }
    
    .order {
      cursor: pointer;
    }
  </style>
</head>

<body>
  <!--NOTE HTML代码部分-->


  <!--　◆◆　　◆◆◆◆◆◆◆◆◆◆　◆◆◆◆◆◆　　　　
　　◆　　◆　◆　◆　◆　◆◆　◆◆　　◆　　　　　
　　◆　　◆　　　◆　　　◆◆　◆◆　　◆　　　　　
　　◆◆◆◆　　　◆　　　◆◆　◆◆　　◆　　　　　
　　◆　　◆　　　◆　　　◆　◆　◆　　◆　　　　　
　　◆　　◆　　　◆　　　◆　◆　◆　　◆　　　　　
　　◆　　◆　　　◆　　　◆　◆　◆　　◆　　　◆　
　◆◆　　◆◆　◆◆◆　◆◆　◆　◆◆◆◆◆◆◆◆　
　　　　　　　　　　　　　　　　　　　　　　　　　　-->

  <div class="container" id="tableContent">
    <div class="panel panel-default">
      <div class="panel-heading">表格复用组件示例</div>
      <!--外部组件-->
      <ht-table ajaxurl="/users/allUser" ref="profile">
        <!--内部组件-->
        <!--NOTE 现存问题是如何获取当前元素内的子组件-->
        <column slot name="名称" data-key="name" align="center" filter="status"></column>
        <column slot name="性别" data-key="gender" align="center" filter="toGender"></column>
        <column slot name="时间" data-key="Regtime" align="center" filter="normaltime"></column>
        <column slot name="编辑" data-key="ID" align="center" filter="toHref"></column>
      </ht-table>
    </div>

  </div>
  <!--
　　　　　　◆　　　　　　　　　　　◆　　　　　　
　◆◆◆　　◆　　◆◆◆　　　　　　◆　　　　　　
　◆　◆　◆◆◆　◆　◆　◆◆◆◆◆◆◆◆◆◆◆　
　◆　◆　　◆　　◆　◆　　　　　　◆　　　　　　
　◆◆◆　　◆　　◆　◆　　　　　◆◆◆　　　　　
　◆　◆　◆◆◆　◆　◆　　　　◆　◆　◆　　　　
　◆　◆　　◆　　◆　◆　　　　◆　◆　◆　　　　
　◆◆◆　◆　　　◆　◆　　　◆　　◆　　◆　　　
　◆　◆　◆　◆　◆　◆　　◆　　　◆　　　◆　　
　◆　◆　◆◆◆　◆◆◆　◆　◆◆◆◆◆◆◆　◆　
　◆　◆　　　　　◆　　　　　　　　◆　　　　　　
　　◆◆　　　　　◆　　　　　　　　◆　　　　　　-->
  <!--NOTE脚本部分-->
  <script src='http://cdn.bootcss.com/jquery/1.9.1/jquery.min.js'></script>
  <script src='http://cdn.bootcss.com/bootstrap/3.3.4/js/bootstrap.min.js'></script>
  <script src='../../Script/Vue/vue.js'></script>
  <script src="https://cdn.bootcss.com/vue-resource/1.3.1/vue-resource.min.js"></script>
  <script>
    var filePath = 'Vue/doc/table.html'; //此处填写相对于public/的目录
  </script>
  <script src='../../Script/ScoketByMa.js'></script>
  <script>
    // 　　◆　　　　　　　◆　　　　　　　　◆◆◆◆　　
    // 　　　◆　　　　　　◆　　◆　　　　　◆　　　　　
    // 　　　　　　　　　　◆　　　◆　◆◆◆◆◆◆◆◆　
    // 　　　　　◆◆◆◆◆◆◆　　　　◆　　◆　　　◆　
    // 　◆◆◆　　　　　　◆　　　　　◆　　◆◆◆　　　
    // 　　　◆　　◆　　　◆　　◆　　◆◆◆◆　　　◆　
    // 　　　◆　　　◆　　◆　　　◆　◆　　　◆◆◆◆　
    // 　　　◆　　　◆　　◆　　　　　◆　　◆　　　　　
    // 　　　◆　　　　　　◆　　　　　◆　　　◆　　　　
    // 　　　◆　　　　◆◆◆　　　◆　◆　◆　　　◆　　
    // 　　◆　◆　　　　　　　　◆　　◆◆　◆　◆　◆　
    // 　◆　　　◆◆◆◆◆◆◆　　　◆　　　◆◆◆　　　
    //NOTE 全局过滤插件　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　
    Vue.filter('normaltime', function(value) {
      //这个过滤器必须是毫秒级别的过滤
      var tm = Date.parse(value);
      var tt = new Date(parseInt(tm)).toLocaleString('chinese', {
        hour12: false
      }).replace(/\//g, "-");
      return tt;
    });　　
    Vue.filter('toGender', function(value) {
      return value == "M" ? "男" : "女";
    });　　

    function toGender(value) {
      return value == "M" ? "男" : "女";
    };

    function toHref(value) {
      var str = "<a href=" + value + ">好的</a>";
      return str;
    }

    function normaltime(value) {
      //这个过滤器必须是毫秒级别的过滤
      var tm = Date.parse(value);
      var tt = new Date(parseInt(tm)).toLocaleString('chinese', {
        hour12: false
      }).replace(/\//g, "-");
      return tt;
    }

    function parseText(str) {
      if (str.indexOf(0) == ("{") || str.indexOf(0) == ("[")) {
        //应该有更高效的，献丑
        str = str.replace(/'/g, "\"");
        str = str.replace(/(\s?\{\s?)(\S)/g, "$1" + "\"" + "$2");
        str = str.replace(/(\s?,\s?)(\S)/g, "$1" + "\"" + "$2");
        str = str.replace(/(\S\s?):(\s?\S)/g, "$1" + "\":" + "$2");
        str = str.replace(/,"\{/g, ",{");
        str = str.replace(/""/g, "\"");
        str = str.replace(/\s/g, "");
        try {
          str = JSON.parse(str)
        } catch (e) {}
      }
      return str;
    }　　　　　　　　　　　　　　　
    // 　　　◆　　　◆　◆　　　　　◆　　　　　　◆◆　
    // 　　　◆　◆◆◆◆◆◆◆　　　◆　　◆◆◆◆　　　
    // 　　　◆　　　◆　◆　　　　　◆　　◆　　　　　　
    // 　◆◆◆◆　◆◆◆◆◆　　◆◆◆◆　◆　　　　　　
    // 　　　◆　　◆　　　◆　　　　◆　　◆◆◆◆◆◆　
    // 　　◆◆　　◆◆◆◆◆　　　◆◆◆　◆　◆　　◆　
    // 　　◆◆◆　◆　　　◆　　　◆◆　◆◆　◆　　◆　
    // 　◆　◆　　◆◆◆◆◆　　◆　◆　　◆　◆　◆　　
    // 　　　◆　　　　◆　　　　　　◆　　◆　◆　◆　　
    // 　　　◆　◆◆◆◆◆◆◆　　　◆　　◆　　◆　　　
    // 　　　◆　　　◆　◆　　　　　◆　◆　　◆　◆　　
    // 　　　◆　◆◆　　　◆◆　　　◆◆　　◆　　　◆　
    //NOTE 模板声明部分
    Vue.component('ht-table', {
      template: '\
        <div>\
          <table class="table table-hover">\
          <thead>\
          <tr><th>#</th><th v-for="x in rule" :width="x.width">{{x.name}}</th></tr>\
          </thead><tbody>\
            <tr v-for="(x,index) in valuelist">\
            <td>{{index+1}}</td>\
            <td v-for="y in rule" >\
                {{render(x[y.dataKey],y.filter)}}\
              </td>\
            </tr>\
          </tbody>\
          </table>\
        </div>',
      //NOTE 如何在此处将数据进行过滤处理是一个问题
      //获取当前的过滤器并进行处理
      props: ["ajaxurl"],
      data: function() {
        return {
          valuelist: [],
          rule: []
        }
      },
      filter: {
        toGender: function(value) {
          return value == "M" ? "男" : "女";
        }
      },
      methods: {
        toshow: function(e) {
          e.preventDefault();
          this.$emit("chuandi");
        },
        //异步请求数据
        getlist: function() {
          var data = new Object();
          var self = this;
          $.ajax({
            type: "GET",
            url: this.ajaxurl,
            dataType: "json",
            success: function(data) {
              if (data != null && data != "") {
                if (data.dataSuccess) {　
                  self.valuelist = data.data;
                } else {}　
              } else {}
            }　
          });
        },
        render: function(tdData, rule) {
          //如果filter存在
          if (rule) {
            var filter = rule;
            if (window[filter]) {
              var newdata = window[filter](tdData);
              console.log(newdata);
              return newdata;
            } else {
              return tdData;
            }
            // if (typeof filter == "string") {
            //   tdData = (this[filter] && this.filter[filter](tdData)) || tdData;
            // } else if (util.isArray(filter)) {
            //   var theOne = filter.filter(function(o) {
            //     return o.key == tdData;
            //   });
            //   if (theOne.length > 0) {
            //     tdData = theOne[0].value
            //   }
            // }

          } else {
            return tdData;
          }


        },
      },
      //在组件加载完成后的钩子
      mounted: function() {
        this.getlist();
        var _this = this;
        console.log(_this.$slots.default);
        // 这个属性  废了好大劲才百度到 神TM坑
        _this.$slots.default.forEach(function(child) {
          // 把column的配置整合到rule中
          var obj = {};
          // 不知道网上谁开始说的VUE好学的  呵呵哒
          // 是因为智商不够么  /(ㄒoㄒ)/~~
          for (var p in child.componentOptions.propsData) {
            obj[p] = child.componentOptions.propsData[p]
          }
          _this.rule.push(obj)
          console.log(child.componentOptions.propsData);
        })
        console.log(_this.rule.length);
        console.log(_this.rule);
        console.log(JSON.stringify(_this.rule));
      }
    });
    Vue.component('column', {
      // template: '<span style="display: none">123</span>',
      template: '<span>123</span>',
      props: {
        dataKey: {
          type: String
        },
        name: {
          type: String,
          required: true
        },
        align: {
          type: String,
          default: 'left'
        },
        filter: [String, Array],
        width: String,
        action: [String, Array, Object]
      },
      data: function() {
        return {}
      },
      mounted: function() {
        // 把{key:1}变成object
        var filter = this.filter;
        if (filter && !$.isPlainObject(filter)) {
          this.filter = parseText(filter);
        }
        var action = this.action;
        if (action && !$.isPlainObject(action)) {
          this.action = parseText(action);
          if ($.isPlainObject(this.action)) {
            this.action = [this.action];
          }
        }
        console.log(this.filter);
        console.log(this.name);
        console.log(this.align);
        console.log(this.width);
        console.log("值：" + this.dataKey);
      }
    });
    Vue.component('my-table', {
      template: '<div style="color:red;">111111</div>'
    });
    // 　　　　　　◆　　　　　　　◆◆◆◆◆　◆◆◆◆◆　
    // 　◆◆◆◆◆◆◆◆◆◆◆　　◆　　　◆　◆　　　◆　
    // 　　　　　　◆　　　　　　　◆　　　◆　◆　　　◆　
    // 　　◆◆◆◆◆◆◆◆◆　　　◆　　　◆　◆◆◆◆◆　
    // 　　　　　　　　　　　　　　◆◆◆◆◆　◆　　　◆　
    // 　　◆◆◆◆◆◆◆◆◆　　　◆　　　◆　◆　　　◆　
    // 　　◆　　　◆　　　◆　　　◆　　　◆　◆◆◆◆◆　
    // 　　◆　　　◆　　　◆　　　◆　　　◆　◆　　　◆　
    // 　　◆◆◆◆◆◆◆◆◆　　　◆◆◆◆◆　◆　　　◆　
    // 　　◆　　　　　　　◆　　　◆　　　　　◆　　　◆　
    // 　　◆　　　　　　　　　　　　　　　　◆　　　　◆　
    // 　◆　　　　　　　　　　　　　　　　◆　　　◆◆◆　
    var tableContent = new Vue({
      el: "#tableContent",
      //数据部分 
      data: {},
      //方法
      methods: {},
      //过滤器
      filters: {},
      //实时计算
      computed: {},
      //加载后立即执行的方法(created 这个钩子在实例被创建之后被调用)
      created: function() {}
    });
    // Vue.set(vuecontent.tabledata, 1, "我是利用Vue.set修改后的名称，否则你看不到我");
  </script>
</body>

</html>