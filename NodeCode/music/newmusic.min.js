const nodegrass=require("nodegrass"),cheerio=require("cheerio"),fs=require("fs"),mysql=require("mysql"),Q=require("q"),path=require("path"),io=require("socket.io")(),DbHelper=require("F:/PersonCodes/NodeAngular项目/NodeCode/zhihu/mysql.js"),async=require("async");let SPIDER_INDEX=1,PAYLIST_INDEX=0,PAYLIST_ARR=[];function getlist(e){nodegrass.get("http://music.163.com/discover/playlist/?order=hot&cat=%E5%8D%8E%E8%AF%AD&limit=35&offset="+35*e,(t,o,l)=>{var s=cheerio.load(t);console.log(t),fs.writeFile(path.resolve(__dirname,"./a.txt"),t),console.log(s("#m-disc-pl-c #m-pl-container").html());var i=s("#m-disc-pl-c #m-pl-container").find("li");i.length>0?(console.log("调试结果:",i.length),s("#m-disc-pl-c #m-pl-container").find("li").each(function(e,t){let o=s(this).find(".nb").text(),l=0;if(o.indexOf("万")>0&&(l=o.split("万")[0]>0?o.split("万")[0]:0),l>0){console.log(l+"万");let e={name:"",collectCount:"",imgSrc:"",href:""},t="http://localhost:9999/playlist"+s(this).find(".u-cover .msk").attr("href").replace("playlist","detail"),o=s(this).find(".u-cover .msk").attr("href");e.name=s(this).find(".u-cover .msk").attr("title").trim().replace(/[&\|\\\*^%$#@\-]/g,""),e.collectCount=l,e.imgSrc=s(this).find("img.j-flag").attr("src"),e.href=o,e.playId=o.split("id=")[1],DbHelper.listAdd(e),PAYLIST_ARR.push(t)}}),setTimeout(function(){e++,console.log("当前抓取的页面是:第"+e+"页面"),getlist(e)},1e3)):(console.log("↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓"),console.log("当前待抓取歌单数量为:"+PAYLIST_ARR.length),fs.writeFile(path.resolve(__dirname,"./a.txt"),"当前待抓取歌单数量为:"+PAYLIST_ARR.length),console.log("↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑"),beginGrapMusic(5))})}function upVersionGetlist(e){nodegrass.get(`http://localhost:9999/top/playlist/highquality?cat=%E7%B2%A4%E8%AF%AD&limit=30&offset=${35*e}`,(t,o,l)=>{var s=JSON.parse(t)&&JSON.parse(t).playlists;s&&s.length>0?(console.log("调试结果:",s.length),s.forEach(function(e,t,o){let l=e.playCount,s=Math.round(l/1e4);if(s>0){console.log(s+"万");let t={name:"",collectCount:"",imgSrc:"",href:""},o=`http://localhost:9999/playlist/detail?id=${e.id}`,l=`/playlist?id=${e.id}`;t.name=e.name,t.collectCount=s,t.imgSrc=e.coverImgUrl,t.href=l,t.playId=e.id,DbHelper.listAdd(t),PAYLIST_ARR.push(o)}}),setTimeout(function(){e++,console.log("当前抓取的页面是:第"+e+"页面"),getlist(e)},1e3)):(console.log("↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓"),console.log("当前待抓取歌单数量为:"+PAYLIST_ARR.length),console.log("↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑"),beginGrapMusic(5))})}function beginGrapMusic(e){async.mapLimit(PAYLIST_ARR,e,(e,t)=>{setTimeout(function(){getPlayListDetail(e+"&timestamp="+(new Date).getTime(),t)},1e4)},(e,t)=>{e?console.log(e):console.log("全部已下载完毕！")})}function getPlayListDetail(e,t){var o=e.split("?id=")[1];setTimeout(()=>{nodegrass.get(e,e=>{if(e){for(var l=JSON.parse(e),s=0;s<l.privileges.length;s++){var i=l.privileges[s],n={id:i.id,collectid:o,name:"",comment:""};DbHelper.musicAdd(n),SPIDER_INDEX++,console.log(l.playlist.name+"第"+SPIDER_INDEX+"首:"+i.id)}t(null,"successful!")}else console.log("请求失败...")})},1e3)}getMusicList(1,1e3);var MUSICLIST=[];function getMusicList(e,t){DbHelper.getEmptyCommentMusicList(e,t,t=>{if(t&&t.length){for(var o=0;o<t.length;o++){var l=t[o];MUSICLIST.push(l)}setTimeout(()=>{getMusicList(++e,1e3)},500)}else getMusic(5)})}function getMusic(e){console.log("↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓"),console.log("开始进行请求"),console.log("↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑"),async.mapLimit(MUSICLIST,e,function(e,t){setTimeout(function(){getSingleMusicComment(e,t)},1e3)},function(e,t){e?console.log(e):console.log("全部已下载完毕！")})}function getSingleMusicComment(e,t){var o=e.mid,l=e.id;setTimeout(function(){nodegrass.get("http://localhost:9999/comment/music?id="+o+"&limit=1&offset=2",o=>{e.total=JSON.parse(o).total||0,DbHelper.updateMusic(e),t(null,"success")}).on("error",function(e){console.log("Got error: "+e.message),t(null,"success")})},1e3)}var EMPTY_NAME_MUSIC_LIST=[];function getEmptyNameMusicList(e,t){DbHelper.getEmptyMusicList(e,t,t=>{if(t&&t.length&&e<=10){for(var o=0;o<t.length;o++){var l=t[o];EMPTY_NAME_MUSIC_LIST.push(l)}console.log(e+"页面"),setTimeout(function(){getEmptyNameMusicList(++e,1e3)},500)}else getEmptyNameMusic(3)})}function getEmptyNameMusic(e){console.log("↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓"),console.log("开始进行歌曲名称详情请求"),console.log("↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑"),async.mapLimit(EMPTY_NAME_MUSIC_LIST,e,(e,t)=>{setTimeout(()=>{getSingleMusicName(e,t)},1e3)},(e,t)=>{e&&console.log(e),!e&&console.log("全部已下载完毕！")})}function getSingleMusicName(e,t){var o=e.mid,l=e.id;setTimeout(()=>{nodegrass.get("http://localhost:9999/song/detail?ids="+o,o=>{try{let l=JSON.parse(o);e.name=l.songs&&l.songs.length>0?l.songs[0].name:"",e.author=l.songs&&l.songs.length>0&&l.songs[0].ar&&l.songs[0].ar.length>0?l.songs[0].ar[0].name:"",e.name||e.author?DbHelper.updateMusicName(e):DbHelper.deleteMusicById(e.id),t(null,"success")}catch(e){console.log(e)}}).on("error",function(e){console.log("Got error: "+e.message),t(null,"success")})},1e3)}function radomNum(e,t){return t=e>t?[e,e=t][0]:t,parseInt(Math.random()*(t-e)+e+1)}function getHighCommentMusicList(e,t){DbHelper.getHighQualityMusicList(e,t,e=>{if(e){console.log("当前获取到的数据有"+e.length+"条");for(var t=[],o=0;o<e.length;o++){var l=e[o];t.push(l.mid)}console.log("■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■"),console.log(t.join(",")),console.log("■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■")}})}