var nodegrass=require("nodegrass");let Handler=require("./handle"),path=require("path"),fs=require("fs");var cheerio=require("cheerio");let START_INDEX=0,PAGE_COUNT=3,IS_GIF=!1,MIN_DIANZAN=0,USER_INPUT="38643401";function getPage(e){return new Promise(function(t,n){let r=e.substr(e.lastIndexOf("/")+1);nodegrass.get(e,(e,a,s)=>{if(e){let n=cheerio.load(e),a=Handler.handleTitle(n(e).find("title").text().trim());Handler.log(a);let s=Handler.getNum(n(e).find(".List-headerText span").text());var l;Handler.log(`当前答案回答数:${s}`),t({ansCount:s,questionId:r,anstitle:a})}else n(error)})})}async function CircleGetAnswer(e){let t=e.ansCount,n=e.questionId,r=e.anstitle,a=path.resolve(__dirname,"./img/"+r);Handler.createDir(a),0==PAGE_COUNT&&(PAGE_COUNT=Math.ceil(e.ansCount/10));for(var s=START_INDEX;s<START_INDEX+PAGE_COUNT;s++){var l=await getAnswer(s,n,r);for(let e=0;e<l.length;e++)await ansList(l[e],a,r)}}function getAnswer(e,t,n){Handler.log(`请求第${e}页`);var r=Handler.getAnswerUrlByPageIndex(t,e);return new Promise(function(t,a){nodegrass.post(r,(r,s,l)=>{r?t(parseResult(r)):a(`问题:${n}当前第${e}页答案获取失败,请检查程序`)})})}async function ansList(e,t,n){function r(n){return{url:e.imgList[n]||"",path:t+"\\"+e.answerId+"--"+n+"--"+path.basename(e.imgList[n]||"").substr(-10)}}if(e.imgList.length>0)for(let t=0;t<e.imgList.length;t+=2)await Promise.all([Handler.startDownloadTask(r(t).url,r(t).path,n,IS_GIF),Handler.startDownloadTask(r(t+1).url,r(t+1).path,n,IS_GIF)]).then(()=>console.log("✲✲✲✲✲✲✲✲✲完成两个✲✲✲✲✲✲✲✲✲✲✲"),e=>console.log(e))}function parseResult(e){let t=JSON.parse(e),n=cheerio.load(e);if(t.msg.length>0){let e=t.msg;var r=[];for(let a=0;a<t.msg.length;a++){let t=n(e[a]).find(".count").text();if(t>=MIN_DIANZAN){let s=n(e[a]).find(".zm-item-rich-text").attr("data-entry-url");s=s.substr(s.lastIndexOf("/")+1);let l=n(e[a]).find(".zm-editable-content").find("noscript").remove().end().find("img");console.log(`答案ID: ${s} ■■■ 点赞数： ${t} ■■■ 图片数量： ${l.length}`);let i=[];l.each(function(e,t){let r=Handler.handleImgUrl(n(this).attr("data-original")||n(this).attr("data-actualsrc")||"");i.push(r)});let o={answerId:s,dianzan:t,imgList:i};r.push(o)}}return r}return[]}getPage(isNaN(USER_INPUT)?USER_INPUT:`https://www.zhihu.com/question/${USER_INPUT}`).then(e=>CircleGetAnswer(e),e=>{console.log(e)});